<head>
<meta charset="utf-8">
<title>gl2f local files</title>

<script src="index.js"></script>
<script src="common.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/modaal@0.4.4/dist/js/modaal.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/modaal@0.4.4/dist/css/modaal.min.css">

<link rel="stylesheet" href="style.css">

<style>

th{
	padding:8px 8px;
	position: sticky;
	top:0;
	background: lightcoral;
}

td{
	padding: 4px 8px;
	background: lavenderblush;
}

tr:nth-child(odd) td{
	background: white;
}

</style>
</head>

<body>

<header style="justify-content: left;">
	<nav id='links'></nav>

	<span id='columns' style="margin-left: 8px;"></span>
	<div style='margin-left:8px;'>
		<select id=filter_board></select>
		<select id=filter_author></select>
	</div>

</header>

<main>
	<div id=notificationContainer class="notificationContainer"></div>

	<div id=tableContainer style="display: inline-block;">
		<table style="margin: 0; border-collapse: collapse;">
			<thead id='thead'></thead>
			<tbody id='tbody'></tbody>
		</table>
	</div>

	<div id='media' style="display:none"></div>
</main>

<div id="tileContextMenu" class="context-menu"></div>

<script type="text/javascript">

const notifier = new Notification();

function createArticleUrl(id)
{
	return `article.html?${id}`;
}

function createAlbumUrl(id)
{
	return `album.html?${id}`;
}

function canCopyImage(target)
{
	return target.tagName === 'IMG' && navigator.clipboard && navigator.clipboard.write;
}

function canCopyText()
{
	return navigator.clipboard && navigator.clipboard.writeText;
}

function initCustomContextMenu(event, items)
{
	event.preventDefault();

	tileContextMenu.replaceChildren();
	items.forEach(i => tileContextMenu.appendChild(i));

  const menuWidth = tileContextMenu.offsetWidth;
  const menuHeight = tileContextMenu.offsetHeight;
  let posX = event.clientX;
  let posY = event.clientY;
  if (posX + menuWidth > window.innerWidth) {
    posX -= menuWidth;
  }
  if (posY + menuHeight > window.innerHeight) {
    posY -= menuHeight;
  }

	tileContextMenu.style.top = `${posY}px`;
	tileContextMenu.style.left = `${posX}px`;
	tileContextMenu.style.display = 'block';
}

function createContextMenuButton(title, command, canExecute)
{
	const button = document.createElement('button');
	button.appendChild(document.createTextNode(title));
	button.onclick = command;
	button.style.whiteSpace = 'nowrap';
	if (!canExecute)
	{
		button.disabled = true;
	}
	return button;
}

media.addEventListener('contextmenu', event =>{
	if(event.target.tagName === 'IMG')
	{
	  const img = event.target;
  	const ar = event.target.src.split('/');
		const id = ar[ar.length - 2];

	  const items =  [];

	  items.push(createContextMenuButton('View article',
	  	() => {
		  	window.open(createArticleUrl(id), '_blank');
		  }, true));
	  items.push(createContextMenuButton('View article in FC',
	  	() => {
	  		const board = table[id]['board'];
	  		window.open(createFcArticleUrl(board, id));
	  	}, true));
		items.push(createContextMenuButton("Open image in new tab",
			() => {
				window.open(img.src, '_blank');
			}, true));

		items.push(document.createElement('hr'));

		items.push(createContextMenuButton('Copy image',
			async () => {
				const canvas = document.createElement('canvas');
				canvas.width = img.naturalWidth;
				canvas.height = img.naturalHeight;

				const ctx = canvas.getContext('2d');
				ctx.drawImage(img, 0, 0);

				new Promise(resolve => canvas.toBlob(resolve, 'image/png'))
				.then(blob => navigator.clipboard.write([new ClipboardItem({[blob.type]: blob})])
					.then(_ => notifier.info('Image copied.')))
				.catch(_ => notifier.error('Failed to copy the image.'));
			},
			canCopyImage(img)));
		items.push(createContextMenuButton("Copy image address",
			() =>{
				navigator.clipboard.writeText(img.src)
				.then(_ => notifier.info('Image path copied.'))
				.catch(_ => notifier.error('Failed to copy the image path.'));
			},
			canCopyText()));

		initCustomContextMenu(event, items);
	}

	if (event.target.tagName === 'VIDEO')
	{
	  const video = event.target;
  	const ar = event.target.src.split('/');
		const id = ar[ar.length - 2];

	  const items = [];

	  items.push(createContextMenuButton("View article",
	  	() => {
		  	window.open(createArticleUrl(id), '_blank');
		  }, true));
	  items.push(createContextMenuButton('View article in FC',
	  	() => {
	  		const board = table[id]['board'];
	  		window.open(createFcArticleUrl(board, id));
	  	}, true));
		items.push(createContextMenuButton("Open video in new tab",
			() => {
				window.open(video.src, '_blank');
			}, true));

	  items.push(document.createElement('hr'));

	  items.push(createContextMenuButton("Open video in new tab",
	  	() =>{
		  	window.open(video.src, '_blank');
		  }, true));

	  items.push(createContextMenuButton("Copy video address",
	  	() => {
		  	navigator.clipboard.writeText(video.src)
		  	.then(_ => notifier.info('Video path copied.'))
		  	.catch(_ => notifier.error('Failed to copy the video path.'))
		  },
		  canCopyText()));

		initCustomContextMenu(event, items);
	}
});

document.addEventListener('click', () => {
  tileContextMenu.style.display = 'none';
});

const columnDefs = {
	ID:{
		data:(k, v)=>`<a href='./contents/${k}'>${k}</a>`,
		default: false,
	},
	Date:{
		key:'date',
		data:(k, v)=>`${new Date(v['date']).toLocaleDateString('ja-JP')}`,
		default: true,
	},
	Expired:{
		key:'expired',
		data:(k, v)=> v['expired']? new Date(v['expired']).toLocaleDateString('ja-JP') : "",
		default: false,
	},
	Board:{
		key:'board',
		data:(k, v)=>`<a href='https://girls2-fc.jp/page/${v['board']}/${k}' target='_blank'>${v['board']}</a>`,
		default: true,
	},
	Author:{
		key:'author',
		data:(k, v)=>`<center style="white-space: nowrap">${v['author']}`,
		default: true,
	},
	Title:{
		key:'title',
		data:(k, v)=>['girls2radio', 'lucky2radio', 'wallpaper', 'commercialmovie', 'gtube'].includes(v['board'])?
			`<a href=${createAlbumUrl(k)}>${v['title']}</a>`
			: `<a href=${createArticleUrl(k)}>${v['title']}</a>&nbsp;/&nbsp;<a href=album.html?${k}>Album</a>`,
		default: true,
	},
};

const queryState = {
	sort: {
		key: 'date',
		order: -1,
	},
	filter: {
		board: '*',
		author: '*',
	}
};

var visibility = Object.fromEntries(Object.entries(columnDefs).map(([k, v]) => [k, v.default]));
const toDisplay = b => b? '' : 'none';

function query(table, state)
{
	const toSortKey = v => String(v[state.sort.key]).toLowerCase();
	return Object.fromEntries(Object.entries(table)
		.filter(([_, v]) => state.filter.board == '*' || state.filter.board == v['board'])
		.filter(([_, v]) => state.filter.author == '*' || state.filter.author == v['author'])
		.sort(([_, l], [__, r]) => toSortKey(l) < toSortKey(r)? -state.sort.order : state.sort.order));
}

const isAlbumVisible = () => {
	const toggleAlbumButton = document.getElementById("toggleAlbumButton");
	return toggleAlbumButton && toggleAlbumButton.checked;
}

function updateTableData()
{
	const cols = Object.entries(columnDefs);
	const items = query(table, queryState);
	tbody.replaceChildren();
	Object.entries(items).forEach(data =>{
		const tr = document.createElement('tr');
		cols.forEach(([ck, cv])=>{
			const td = document.createElement('td');
			td.style.display = toDisplay(visibility[ck]);
			td.innerHTML = cv.data(...data);

			tr.appendChild(td);
		});
		tbody.appendChild(tr);
	});

	if (isAlbumVisible())
	{
		updateMediaTile();
	}
};

function updateMediaTile() {
	const items = query(table, queryState);
	const mediaList = Object.entries(items).flatMap(([k, v])=>v['media'].map(m => {
		const prefix = v['author']? v['author'] : v['board'];
		return {
			path: `${k}/${m}`,
			displayName: `[${prefix}] ${v['title']}`,
		}
	}));
	media.replaceChildren();
	media.appendChild(document.createElement('hr'));
	media.appendChild(tileMedia(mediaList, window.innerWidth-100, 4, false, notifier));
	setupModaal();
}

function updateAlbumVisibility()
{
	const v = isAlbumVisible();
	updateMediaTile();
	tableContainer.style.maxHeight = v? '30vh' : '';
	tableContainer.style.overflow = v? 'auto': '';
	media.style.display = toDisplay(v);
}

const updateLabel = () => Object.entries(columnDefs).forEach(([k, v]) =>
{
	const arrow = v.key != queryState.sort.key? '↑↓' : queryState.sort.order == 1? '↑':'↓';
	document.getElementById(`th_${v.key}`).innerHTML = `${k}&thinsp;${arrow}`;
});


function initTHead()
{
	const row = document.createElement('tr');
	Object.entries(columnDefs).forEach(([k, v]) => {
		const th = document.createElement('th');
		th.setAttribute('data-column', k);
		th.style.display = toDisplay(v.default);

		const e = document.createElement('div');
		e.className = 'buttonlike';
		e.id = `th_${v.key}`;
		e.addEventListener('click', ()=>{
			if (queryState.sort.key == v.key)
				queryState.sort.order *= -1;
			else{
				queryState.sort.key = v.key;
				queryState.sort.order = 1;
			}
			updateLabel();
			updateTableData();
		});
		th.appendChild(e);

		row.appendChild(th);
	});

	thead.appendChild(row);
}

function initFilter(id)
{
	const e = document.getElementById(`filter_${id}`);
	e.innerHTML = [
		`<option value=*>${id} / all</option>`,
		...Array.from(new Set(Object.values(table).map(v => v[id])))
			.sort().map(b=>`<option value='${b}'>${b}</option>`)
	].join('');

	e.addEventListener('change', () => {
		queryState.filter[id] = e.value;

		updateTableData();
	});
}


function* createNavItems(hostname){
	const home = document.createElement('a');
	home.href = 'index.html';
	home.className = 'navItem';
	home.textContent = hostname || 'Home';
	yield home;

	const album = document.createElement('div');
	album.innerHTML = `<input type="checkbox" class="toggleInput" id="toggleAlbumButton" onchange="updateAlbumVisibility()">
	<label class="NavItem toggleButton" for="toggleAlbumButton">Album</label>`;
	yield album;
};

updateHostName(hostname => {
	document.title = `${hostname}/gl2f`;
	createNavItems(hostname).forEach(e => links.appendChild(e));
}, ()=>{
	document.title = `local/gl2f`;
	createNavItems(null).forEach(e => links.appendChild(e));
});

Object.keys(columnDefs).forEach(k => {
	const label = document.createElement('label');
	label.className = 'buttonlike';

	const checkbox = document.createElement('input');
	checkbox.id = `col_${k}`;
	checkbox.className = 'buttonlike';
	checkbox.type = 'checkbox';
	checkbox.checked = columnDefs[k].default;
	checkbox.addEventListener('change', ()=>{
		visibility[k] = checkbox.checked;
		document.querySelectorAll(`[data-column="${k}"]`).forEach(cell =>{
			cell.style.display = toDisplay(visibility[k]);
		});

		updateTableData();
	});

	label.appendChild(checkbox);
	label.appendChild(document.createTextNode(k));
	columns.appendChild(label);
});

initTHead();

initFilter('board');
initFilter('author');
updateLabel();
updateTableData();
updateAlbumVisibility();

tileContextMenu.addEventListener('contextmenu', event => {
	event.preventDefault();
});
</script>

</body>
