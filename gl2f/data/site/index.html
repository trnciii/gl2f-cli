<head>
<title>gl2f local files</title>
<link rel="stylesheet" href="style.css">
</head>


<body>

<header>
	<span class='item' id='columns'></span>
	<span class='item' id='filter_board'></span>
	<span class='item' id='filter_author'></span>
</header>

<table>
	<thead id='thead'></thead>
	<tbody id='tbody'></tbody>
</table>


<script src="index.js"></script>
<script type="text/javascript">
const f = {
	Date:{
		key:'date',
		head:()=>'Date',
		data:(k, v)=>`${new Date(v['date']).toLocaleDateString('ja-JP')}`,
	},
	Page:{
		key:'board',
		data:(k, v)=>`<a href='https://girls2-fc.jp/page/${v['board']}' target='_blank'>${v['board']}</a>`,
	},
	Author:{
		key:'author',
		data:(k, v)=>`<center class='nowrap'>${v['author']}`,
	},
	Title:{
		key:'title',
		data:(k, v)=>`<a href=album.html?${k}>${v['title']}</a>`,
	},
};

const keys = Object.keys(f);

var sort_state = {
	key:'date',
	order:-1
};


function filter(table, key){
	const b = document.getElementById(`flt_${key}`).value;
	if(b == 'all') return table;
	else return Object.fromEntries(Object.entries(table).filter(([k, v])=>v[key]==b));
}

function sort(table, key, order){
	const lower = (s)=>String(s).toLowerCase();
	const entries = Object.entries(table)
		.sort(([kl, vl], [kr, vr])=>lower(vl[key])<lower(vr[key])?-order:order);
	return Object.fromEntries(entries);
}


function draw(){
	const columns = keys.filter(k=>document.getElementById(`col_${k}`).checked);
	document.getElementById('thead')
	.innerHTML = '<tr>'
		+ columns.map(c=>`<th><div class="nowrap" id=thead_${c}>${c}&thinsp;${f[c].key==sort_state.key?(sort_state.order==1?'↑':'↓')+'&ensp;':'↑↓'}</div></th>`).join('')
		+ '</tr>';
	columns.forEach((c)=>{
		document.getElementById(`thead_${c}`).onclick = ()=>{
			if (sort_state.key == f[c].key)
				sort_state.order *= -1;
			else{
				sort_state.key = f[c].key;
				sort_state.order = 1;
			}
			draw();
		};
	});

	document.getElementById('tbody').innerHTML = Object.entries(
		sort(filter(filter(table, 'board'), 'author'), sort_state.key, sort_state.order)
	).map(([k, v])=>'<tr>'
		+ columns.map((c)=>`<td>${f[c].data(k, v)}</td>`).join('')
		+ '</tr>'
	).join('');
};


document.getElementById('columns').innerHTML = keys.map(
	k=>`<input class='item' id=col_${k} type='checkbox' checked>${k}</input>`
).join('');

keys.map(k=>document.getElementById(`col_${k}`))
.forEach(b=>b.addEventListener('change', draw));


document.getElementById('filter_board').innerHTML = '<select id=flt_board>'
	+ '<option value=all>page / all</option>'
	+	[...new Set(Object.values(table).map(v=>v['board']))].sort().map(b=>`<option value=${b}>${b}</option>`).join('')
	+ '</select>'
document.getElementById('flt_board').onchange = draw;


document.getElementById('filter_author').innerHTML = '<select id=flt_author>'
	+ '<option value=all>author / all</option>'
	+ [...new Set(Object.values(table).map(v=>v['author']))].sort().map(a=>`<option value=${a}>${a}</option>`).join('')
	+ '</select>'
document.getElementById('flt_author').onchange = draw;


draw();
</script>

</body>
