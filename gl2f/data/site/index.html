<head>
<meta charset="utf-8">
<title>gl2f local files</title>

<script src="index.js"></script>
<script src="constants.js"></script>
<script src="common.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/modaal@0.4.4/dist/js/modaal.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/modaal@0.4.4/dist/css/modaal.min.css">

<link rel="stylesheet" href="style.css">

<style>

th{
	padding:8px 8px;
	position: sticky;
	top:0;
	background: lightcoral;
}

td{
	padding: 4px 8px;
	background: lavenderblush;
}

tr:nth-child(odd) td{
	background: white;
}

</style>
</head>

<body>

<header style="justify-content: left;">
	<span id='columns'></span>
	<div style='margin-left:8px;'>
		<select id=filter_board></select>
		<select id=filter_author></select>
	</div>

	<div style='margin-left: 8px; margin-right: 8px;'>
    <input type="checkbox" class="toggleInput" id="toggleAlbumButton" onchange="updateAlbumVisibility()">
    <label class="toggleButton" for="toggleAlbumButton">Album</label>
	</div>

	<div id='hostname' style="display: flex; justify-content: right; margin-top: 2px; margin-left: auto;"></div>
</header>

<main>
	<div id=tableContainer style="display: inline-block;">
		<table style="margin: 0; border-collapse: collapse;">
			<thead id='thead'></thead>
			<tbody id='tbody'></tbody>
		</table>
	</div>

	<div id='media' style="display:none"></div>
</main>

<div id="tileContextMenu" class="context-menu"></div>

<script type="text/javascript">

function createArticleUrl(id)
{
	return `article.html?${id}`;
}

function createAlbumUrl(id)
{
	return `album.html?${id}`;
}

function canCopyImage(target)
{
	return target.tagName === 'IMG' && navigator.clipboard && navigator.clipboard.write;
}

function initCustomContextMenu(event, items)
{
	event.preventDefault();

	tileContextMenu.replaceChildren();
	items.forEach(i => tileContextMenu.appendChild(i));

  const menuWidth = tileContextMenu.offsetWidth;
  const menuHeight = tileContextMenu.offsetHeight;
  let posX = event.clientX;
  let posY = event.clientY;
  if (posX + menuWidth > window.innerWidth) {
    posX -= menuWidth;
  }
  if (posY + menuHeight > window.innerHeight) {
    posY -= menuHeight;
  }

	tileContextMenu.style.top = `${posY}px`;
	tileContextMenu.style.left = `${posX}px`;
	tileContextMenu.style.display = 'block';
}

function createContextMenuButton(title, command)
{
	const button = document.createElement('button');
	button.appendChild(document.createTextNode(title));
	button.onclick = command;
	button.style.whiteSpace = 'nowrap';
	return button;
}

media.addEventListener('contextmenu', event =>{
	if(event.target.tagName === 'IMG')
	{
	  const img = event.target;
	  const items =  [];

	  items.push(createContextMenuButton('View article', () => {
	  	const ar = event.target.src.split('/');
			const id = ar[ar.length - 2];
	  	window.open(createArticleUrl(id), '_blank');
	  }));

		items.push(createContextMenuButton("Open image in new tab",() => {
			window.open(img.src, '_blank');
		}));

		items.push(document.createElement('hr'));

		if(canCopyImage(img))
		{
			items.push(createContextMenuButton('Copy image', async () => {
				const canvas = document.createElement('canvas');
				canvas.width = img.naturalWidth;
				canvas.height = img.naturalHeight;

				const ctx = canvas.getContext('2d');
				ctx.drawImage(img, 0, 0);

				const blob = await new Promise((resolve) => canvas.toBlob(resolve, 'image/png'));

				await navigator.clipboard.write([new ClipboardItem({
					[blob.type]: blob,
				})]);
			}));
		}

		items.push(createContextMenuButton("Copy image address", () =>{
			navigator.clipboard.writeText(img.src);
		}));

		initCustomContextMenu(event, items);
	}

	if (event.target.tagName === 'VIDEO')
	{
	  const video = event.target;
	  const items = [];

	  items.push(createContextMenuButton("View article", () => {
	  	const ar = event.target.src.split('/');
			const id = ar[ar.length - 2];
	  	window.open(createArticleUrl(id), '_blank');
	  }));

	  items.push(document.createElement('hr'));

	  items.push(createContextMenuButton("Open video in new tab", () =>{
	  	window.open(video.src, '_blank');
	  }));

	  items.push(createContextMenuButton("Copy video address", () => {
	  	navigator.clipboard.writeText(video.src);
	  }));

		initCustomContextMenu(event, items);
	}
});

document.addEventListener('click', () => {
  tileContextMenu.style.display = 'none';
});

const columnDefs = {
	ID:{
		data:(k, v)=>`<a href='./contents/${k}'>${k}</a>`,
		default: false,
	},
	Date:{
		key:'date',
		data:(k, v)=>`${new Date(v['date']).toLocaleDateString('ja-JP')}`,
		default: true,
	},
	Expired:{
		key:'expired',
		data:(k, v)=> v['expired']? new Date(v['expired']).toLocaleDateString('ja-JP') : "",
		default: false,
	},
	Board:{
		key:'board',
		data:(k, v)=>`<a href='https://girls2-fc.jp/page/${v['board']}/${k}' target='_blank'>${v['board']}</a>`,
		default: true,
	},
	Author:{
		key:'author',
		data:(k, v)=>`<center style="white-space: nowrap">${v['author']}`,
		default: true,
	},
	Title:{
		key:'title',
		data:(k, v)=>['girls2radio', 'lucky2radio', 'wallpaper', 'commercialmovie', 'gtube'].includes(v['board'])?
			`<a href=${createAlbumUrl(k)}>${v['title']}</a>`
			: `<a href=${createArticleUrl(k)}>${v['title']}</a>&nbsp;/&nbsp;<a href=album.html?${k}>Album</a>`,
		default: true,
	},
};

const queryState = {
	sort: {
		key: 'date',
		order: -1,
	},
	filter: {
		board: '*',
		author: '*',
	}
};

var visibility = Object.fromEntries(Object.entries(columnDefs).map(([k, v]) => [k, v.default]));
const toDisplay = b => b? '' : 'none';

function query(table, state)
{
	const toSortKey = v => String(v[state.sort.key]).toLowerCase();
	return Object.fromEntries(Object.entries(table)
		.filter(([_, v]) => state.filter.board == '*' || state.filter.board == v['board'])
		.filter(([_, v]) => state.filter.author == '*' || state.filter.author == v['author'])
		.sort(([_, l], [__, r]) => toSortKey(l) < toSortKey(r)? -state.sort.order : state.sort.order));
}

function updateTableData()
{
	const cols = Object.entries(columnDefs);
	const items = query(table, queryState);
	tbody.replaceChildren();
	Object.entries(items).forEach(data =>{
		const tr = document.createElement('tr');
		cols.forEach(([ck, cv])=>{
			const td = document.createElement('td');
			td.style.display = toDisplay(visibility[ck]);
			td.innerHTML = cv.data(...data);

			tr.appendChild(td);
		});
		tbody.appendChild(tr);
	});

	if (toggleAlbumButton.checked)
	{
		updateMediaTile();
	}
};

function updateMediaTile() {
	const items = query(table, queryState);
	const mediaList = Object.entries(items).flatMap(([k, v])=>v['media'].map(m => `${k}/${m}`));
	media.replaceChildren();
	media.appendChild(document.createElement('hr'));
	media.appendChild(tileMedia(mediaList, window.innerWidth-100, 4, false));
	setupModaal();
}

function updateAlbumVisibility()
{
	updateMediaTile();
	tableContainer.style.maxHeight = toggleAlbumButton.checked? '30vh' : '';
	tableContainer.style.overflow = toggleAlbumButton.checked? 'auto': '';
	media.style.display = toDisplay(toggleAlbumButton.checked);
}

const updateLabel = () => Object.entries(columnDefs).forEach(([k, v]) =>
{
	const arrow = v.key != queryState.sort.key? '↑↓' : queryState.sort.order == 1? '↑':'↓';
	document.getElementById(`th_${v.key}`).innerHTML = `${k}&thinsp;${arrow}`;
});


function initTHead()
{
	const row = document.createElement('tr');
	Object.entries(columnDefs).forEach(([k, v]) => {
		const th = document.createElement('th');
		th.setAttribute('data-column', k);
		th.style.display = toDisplay(v.default);

		const e = document.createElement('div');
		e.className = 'buttonlike';
		e.id = `th_${v.key}`;
		e.addEventListener('click', ()=>{
			if (queryState.sort.key == v.key)
				queryState.sort.order *= -1;
			else{
				queryState.sort.key = v.key;
				queryState.sort.order = 1;
			}
			updateLabel();
			updateTableData();
		});
		th.appendChild(e);

		row.appendChild(th);
	});

	thead.appendChild(row);
}

function initFilter(id)
{
	const e = document.getElementById(`filter_${id}`);
	e.innerHTML = [
		`<option value=*>${id} / all</option>`,
		...Array.from(new Set(Object.values(table).map(v => v[id])))
			.sort().map(b=>`<option value='${b}'>${b}</option>`)
	].join('');

	e.addEventListener('change', () => {
		queryState.filter[id] = e.value;

		updateTableData();
	});
}

document.title = `${hostname}/gl2f`;

document.getElementById('hostname').innerHTML = `
<div style="font-size:10;">hosted on&nbsp;</div>
<div style="font-weight: bold; font-size:14;">${hostname}</div>`;

Object.keys(columnDefs).forEach(k => {
	const label = document.createElement('label');
	label.className = 'buttonlike';

	const checkbox = document.createElement('input');
	checkbox.id = `col_${k}`;
	checkbox.className = 'buttonlike';
	checkbox.type = 'checkbox';
	checkbox.checked = columnDefs[k].default;
	checkbox.addEventListener('change', ()=>{
		visibility[k] = checkbox.checked;
		document.querySelectorAll(`[data-column="${k}"]`).forEach(cell =>{
			cell.style.display = toDisplay(visibility[k]);
		});

		updateTableData();
	});

	label.appendChild(checkbox);
	label.appendChild(document.createTextNode(k));
	columns.appendChild(label);
});

initTHead();

initFilter('board');
initFilter('author');

updateLabel();
updateTableData();
updateAlbumVisibility();

tileContextMenu.addEventListener('contextmenu', event => {
	event.preventDefault();
});

initFilter('board');
initFilter('author');
updateLabel();
updateTableData();
updateAlbumVisibility();
</script>

</body>
