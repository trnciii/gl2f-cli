<head>
<meta charset="utf-8">

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/modaal@0.4.4/dist/js/modaal.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/modaal@0.4.4/dist/css/modaal.min.css">

<script src="constants.js"></script>
<script src="index.js"></script>

<link rel="stylesheet" href="style.css">

<style>
.header-links {
  display: flex;
  flex:1;
  flex-wrap: wrap;
  margin: 0 0 4 0;
  align-content: flex-start;
  gap:4px;
}

.header-title {
}

.header-controls {
  display: flex;
  flex:1;
  justify-content: right;
  align-items: center;
  padding-left: 8px;
}

@media screen and (max-width: 600px) {
  .blog-header{
    flex-direction: column;
    align-items: stretch;
  }
}
</style>
</head>


<body>

<header class="blog-header">
  <nav id=links class="header-links"></nav>

  <div class="header-title">
    <div id=title></div>
    <div id=meta class=title-meta style="font-size: 14;margin: 0;"></div>
  </div>

  <div class=header-controls>
    <div>
      <input type="checkbox" class="toggleInput" id="toggleButton" onchange="updateTiles()">
      <label class="toggleButton" for="toggleButton" title='on/off file list'>List</label>

      <input type="range" id="cols" min="1" max="7" step="1" title='adjust number of colmuns' oninput="updateTiles()">
    </div>
  </div>
</header>

<main id=main></main>

<script>
const contentId = location.search.split("?")[1];

function tileMedia(mediaList, width, columns, showList)
{
  const itemWidth = width/columns;

  const element = document.createElement('center');

  if(showList)
  {
    const min = 250;

    const list = document.createElement('div');
    list.className = 'tile';
    list.style.marginTop = '20px';
    list.style.marginBottom = '20px';
    list.innerHTML = `<div style="padding:20px; background: pink;text-align:left;">${mediaList.map(i=>`<div class=list-item>${i}</div>`).join('')}</div>`

    element.appendChild(list);
    element.appendChild(document.createElement('br'));
  }

  mediaList.map(i => `contents/${i}`)
    .map(src => {
      const ext = src.slice(src.lastIndexOf('.'));
      if([".jpeg", ".png"].indexOf(ext) > -1){
        return `<a class="image" data-group="gallery" href=${src}><img src="${src}" width=${itemWidth}/></a>`;
      }
      else if([".mp4"].indexOf(ext) > -1){
        return `<a class="iframe" href=${src}><video controls autoplay muted loop src="${src}" width=${itemWidth}/></a>`;
      }
      else if([".mov"].indexOf(ext) > -1){
        return `<video controls autoplay muted loop src="${src}" width=${itemWidth} />`;
      }
      else{
        alert(`Unknown media file: ${src}`);
        return '';
      }
    })
    .forEach(t => {
      const i = document.createElement('div');
      i.className = 'tile';
      i.innerHTML = t;
      element.appendChild(i);
    });

  return element;
}

function updateTiles(){
  const mediaList = table[contentId]['media'].map(e => `${contentId}/${e}`);
  main.replaceChildren();
  main.appendChild(tileMedia(mediaList, window.innerWidth-100, cols.value, toggleButton.checked));
  setupModaal();
}

function calcColumns(n, width, height)
{
  return Math.min(Math.ceil(Math.sqrt(n * width/height)), n);
}

document.getElementById('links').innerHTML = `
<a href=index.html title=${hostname}>Home</a>
<a href=article.html?${contentId}>Article</a>`;

const content = table[contentId];
const media_table = content['media'];

document.title = `${hostname}/Album - ${content['title']}`;

document.getElementById('title').innerHTML = `<h1>${content['title']}</h1>`;
document.getElementById('meta').innerHTML = `
${content['author']}&nbsp;
${new Date(content['date']).toLocaleDateString('ja-JP')}&nbsp;
<a href=https://girls2-fc.jp/page/${content['board']}/${contentId} target=_blank><i class="fa fa-external-link" /></a>`;

cols.value = calcColumns(content['media'].length, window.innerWidth, window.innerHeight);
updateTiles();

</script>

</body>
